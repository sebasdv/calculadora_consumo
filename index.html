<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Calculadora de consumo energético — MCU + sensores</title>
  <style>
/* ============================================================================
 * SEBASDV DESIGN SYSTEM - Sistema de diseño unificado para proyectos GitHub
 * Version: 1.0.0
 * Estética: GameBoy Retro
 * Autor: sebasdv
 * ============================================================================ */

/* ============================================================================
 * 1. VARIABLES DE DISEÑO - Sistema de colores y espaciados
 * ============================================================================ */

:root {
    /* === PALETA GAMEBOY === */
    --gb-primary: #9bbc0f;      /* Verde principal GameBoy */
    --gb-secondary: #8bac0f;    /* Verde secundario GameBoy */
    --gb-dark: #0f380f;         /* Verde oscuro GameBoy */
    --gb-accent: #306230;       /* Verde acento GameBoy */

    /* === ESTADOS Y FEEDBACK VISUAL === */
    --gb-active: #0f380f;       /* Elementos activos/seleccionados */
    --gb-hover: #8bac0f;        /* Estados hover */
    --gb-disabled: #306230;     /* Elementos deshabilitados */
    --gb-focus: #306230;        /* Elementos con foco */

    /* === TEXTO Y CONTRASTE === */
    --gb-text-primary: #0f380f;    /* Texto principal (máximo contraste) */
    --gb-text-secondary: #306230;  /* Texto secundario */
    --gb-text-inverse: #9bbc0f;    /* Texto invertido (claro sobre oscuro) */

    /* === SOMBRAS Y BORDES === */
    --gb-shadow-dark: #0f380f;     /* Sombra principal */
    --gb-shadow-light: #8bac0f;    /* Sombra secundaria */
    --gb-border: #0f380f;          /* Bordes de elementos */

    /* === ESPACIADOS === */
    --spacing-xs: 5px;
    --spacing-sm: 10px;
    --spacing-md: 15px;
    --spacing-lg: 20px;
    --spacing-xl: 30px;

    /* === TAMAÑOS DE FUENTE === */
    --font-size-xs: 8px;
    --font-size-sm: 10px;
    --font-size-md: 12px;
    --font-size-lg: 16px;
    --font-size-xl: 20px;
    --font-size-2xl: 24px;

    /* === BORDES Y RADIOS === */
    --border-width: 2px;
    --border-width-thick: 4px;
    --border-radius: 0px;
    --border-radius-sm: 4px;

    /* === SOMBRAS RETRO === */
    --shadow-sm: 2px 2px 0 var(--gb-shadow-dark);
    --shadow-md: 4px 4px 0 var(--gb-shadow-dark);
    --shadow-lg: 8px 8px 0 var(--gb-shadow-dark);

    /* === TRANSICIONES === */
    --transition-fast: all 0.1s ease;
    --transition-normal: all 0.2s ease;
    --transition-slow: all 0.3s ease;

    /* === Z-INDEX === */
    --z-base: 1;
    --z-overlay: 100;
    --z-modal: 500;
    --z-scanlines: 1000;
    --z-tooltip: 2000;
}

/* ============================================================================
 * 2. RESET Y ESTILOS BASE
 * ============================================================================ */

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    image-rendering: pixelated;
    -webkit-font-smoothing: none;
    -moz-osx-font-smoothing: grayscale;
}

@import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

body {
    background-color: var(--gb-primary);
    font-family: 'Press Start 2P', 'Courier New', monospace;
    color: var(--gb-text-primary);
    line-height: 1.6;
    min-height: 100vh;
    padding: var(--spacing-md);
    touch-action: manipulation;
    max-width: 100vw;
    overflow-x: hidden;
    position: relative;
}

/* Dynamic Viewport Height para móviles */
@media (max-width: 768px) {
    body {
        min-height: 100dvh;
    }
}

/* === EFECTO SCANLINES RETRO === */
body::after {
    content: "";
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: repeating-linear-gradient(
        0deg,
        rgba(0, 0, 0, 0.1),
        rgba(0, 0, 0, 0.1) 1px,
        transparent 1px,
        transparent 2px
    );
    pointer-events: none;
    z-index: var(--z-scanlines);
}

/* ============================================================================
 * 3. TIPOGRAFÍA
 * ============================================================================ */

h1, h2, h3, h4, h5, h6 {
    font-family: 'Press Start 2P', monospace;
    color: var(--gb-text-primary);
    text-shadow: 2px 2px 0 var(--gb-shadow-dark);
    letter-spacing: 2px;
    line-height: 1.4;
}

h1 {
    font-size: var(--font-size-xl);
    margin-bottom: var(--spacing-md);
}

h2 {
    font-size: var(--font-size-lg);
    margin-bottom: var(--spacing-sm);
}

h3 {
    font-size: var(--font-size-md);
    margin-bottom: var(--spacing-sm);
}

p {
    font-size: var(--font-size-sm);
    margin-bottom: var(--spacing-sm);
    line-height: 1.8;
}

.lead {
    font-size: var(--font-size-xs);
    color: var(--gb-text-secondary);
    line-height: 1.8;
}

/* ============================================================================
 * 4. LAYOUT
 * ============================================================================ */

.wrap {
    max-width: 1200px;
    margin: 0 auto;
}

.grid {
    display: grid;
    grid-template-columns: 1fr 400px;
    gap: var(--spacing-md);
    margin-bottom: var(--spacing-md);
}

/* ============================================================================
 * 5. TARJETAS Y PANELES
 * ============================================================================ */

.card {
    background: var(--gb-primary);
    border: var(--border-width) solid var(--gb-border);
    box-shadow: var(--shadow-md);
    padding: var(--spacing-md);
    margin-bottom: var(--spacing-md);
}

.card-header {
    background: var(--gb-dark);
    color: var(--gb-text-inverse);
    padding: var(--spacing-sm);
    margin: calc(var(--spacing-md) * -1) calc(var(--spacing-md) * -1) var(--spacing-md);
    border-bottom: var(--border-width) solid var(--gb-border);
}

/* ============================================================================
 * 6. BOTONES
 * ============================================================================ */

.btn,
button {
    font-family: 'Press Start 2P', monospace;
    font-size: var(--font-size-xs);
    color: var(--gb-text-primary);
    background: var(--gb-primary);
    border: var(--border-width) solid var(--gb-border);
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-md);
    padding: var(--spacing-sm) var(--spacing-md);
    cursor: pointer;
    transition: var(--transition-fast);
    text-transform: uppercase;
    letter-spacing: 1px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    text-decoration: none;
    user-select: none;
    margin-right: var(--spacing-xs);
    margin-bottom: var(--spacing-xs);
}

.btn:hover,
button:hover {
    background: var(--gb-hover);
    transform: translate(1px, 1px);
    box-shadow: 3px 3px 0 var(--gb-shadow-dark);
}

.btn:active,
button:active {
    transform: translate(2px, 2px);
    box-shadow: var(--shadow-sm);
}

.btn-primary {
    background: var(--gb-dark);
    color: var(--gb-text-inverse);
}

.btn-secondary {
    background: var(--gb-secondary);
}

.btn.ghost {
    background: transparent;
    box-shadow: none;
}

/* ============================================================================
 * 7. FORMULARIOS
 * ============================================================================ */

label {
    display: block;
    font-size: var(--font-size-xs);
    margin-top: var(--spacing-sm);
    margin-bottom: var(--spacing-xs);
    color: var(--gb-text-primary);
}

input[type="number"],
input[type="text"],
textarea,
select {
    font-family: 'Press Start 2P', monospace;
    font-size: var(--font-size-xs);
    color: var(--gb-text-primary);
    background: var(--gb-secondary);
    border: var(--border-width) solid var(--gb-border);
    padding: var(--spacing-xs);
    width: 100%;
    transition: var(--transition-normal);
    margin-bottom: var(--spacing-xs);
}

input:focus,
textarea:focus,
select:focus {
    outline: none;
    border-color: var(--gb-accent);
    box-shadow: 0 0 0 2px var(--gb-accent);
}

textarea {
    resize: vertical;
    min-height: 80px;
}

/* ============================================================================
 * 8. TABLAS
 * ============================================================================ */

table {
    width: 100%;
    border-collapse: collapse;
    margin-top: var(--spacing-sm);
    margin-bottom: var(--spacing-sm);
    font-size: var(--font-size-xs);
}

th,
td {
    padding: var(--spacing-xs);
    text-align: left;
    border: 1px solid var(--gb-border);
}

thead th {
    background: var(--gb-dark);
    color: var(--gb-text-inverse);
    font-weight: bold;
    text-transform: uppercase;
}

tbody tr:nth-child(even) {
    background: var(--gb-secondary);
}

tbody input {
    margin-bottom: 0;
}

.row-actions {
    display: flex;
    gap: var(--spacing-xs);
    justify-content: center;
}

/* ============================================================================
 * 9. RESULTADOS Y STATS
 * ============================================================================ */

.results {
    position: sticky;
    top: var(--spacing-md);
}

.stat {
    background: var(--gb-dark);
    color: var(--gb-text-inverse);
    padding: var(--spacing-sm);
    margin-bottom: var(--spacing-sm);
    border: var(--border-width) solid var(--gb-border);
    box-shadow: var(--shadow-sm);
}

.stat-label {
    font-size: var(--font-size-xs);
    margin-bottom: var(--spacing-xs);
    opacity: 0.8;
}

.stat-value {
    font-size: var(--font-size-md);
    font-weight: bold;
    text-shadow: 1px 1px 0 var(--gb-primary);
}

.stat-formula {
    font-size: var(--font-size-xs);
    margin-top: var(--spacing-xs);
    opacity: 0.6;
}

/* ============================================================================
 * 10. FOOTER
 * ============================================================================ */

footer {
    margin-top: var(--spacing-lg);
    padding: var(--spacing-sm);
    font-size: var(--font-size-xs);
    color: var(--gb-text-secondary);
    background: var(--gb-secondary);
    border: var(--border-width) solid var(--gb-border);
    box-shadow: var(--shadow-sm);
    line-height: 1.8;
}

/* ============================================================================
 * 11. RESPONSIVE DESIGN
 * ============================================================================ */

@media (max-width: 768px) {
    :root {
        --font-size-xs: 7px;
        --font-size-sm: 9px;
        --font-size-md: 11px;
        --font-size-lg: 14px;
        --font-size-xl: 16px;
    }

    .grid {
        grid-template-columns: 1fr;
    }

    .card {
        padding: var(--spacing-sm);
    }

    h1 {
        font-size: var(--font-size-lg);
    }

    .results {
        position: static;
    }
}

@media (max-width: 480px) {
    body {
        padding: var(--spacing-xs);
    }

    .btn,
    button {
        font-size: 7px;
        padding: var(--spacing-xs) var(--spacing-sm);
    }

    table {
        font-size: 7px;
    }

    th,
    td {
        padding: 3px;
    }
}

/* ============================================================================
 * 12. UTILIDADES
 * ============================================================================ */

.text-center {
    text-align: center;
}

.mt-md {
    margin-top: var(--spacing-md);
}

.mb-sm {
    margin-bottom: var(--spacing-sm);
}

.flex {
    display: flex;
}

.flex-wrap {
    flex-wrap: wrap;
}

.gap-sm {
    gap: var(--spacing-sm);
}
  </style>
</head>
<body>
  <div class="wrap">
    <header class="card">
      <div class="card-header">
        <h1>POWER CALC</h1>
      </div>
      <p class="lead">Calculadora de consumo energético para MCU y sensores. Pensado para ESP32, Arduino y actuadores. Incluye integración con Wokwi.</p>
    </header>

    <div class="grid">
      <section class="card">
        <div class="card-header">
          <h2>WOKWI IMPORT</h2>
        </div>
        <label>URL del proyecto Wokwi (opcional)</label>
        <input id="wokwi_url" type="text" placeholder="https://wokwi.com/projects/..." />
        <label>Pegar diagram.json</label>
        <textarea id="wokwi_json" rows="4" placeholder='{"version": 1, "parts": [...], "connections": [...]}'></textarea>
        <button class="btn btn-primary" id="parseWokwi">CARGAR WOKWI</button>

        <div class="card-header mt-md">
          <h2>BATERIA</h2>
        </div>
        <label>Capacidad (mAh)</label>
        <input id="batt_mAh" type="number" value="6800" min="1" />
        <label>Voltaje nominal (V)</label>
        <input id="batt_V" type="number" step="0.1" value="3.7" />
        <label>Eficiencia (0-1)</label>
        <input id="eff" type="number" step="0.01" value="0.90" min="0.5" max="1" />

        <div class="card-header mt-md">
          <h2>COMPONENTES</h2>
        </div>

        <table aria-label="tabla componentes">
          <thead>
            <tr><th>Nombre</th><th>V</th><th>mA</th><th>Duty%</th><th>Acción</th></tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>

        <div class="flex flex-wrap mt-md">
          <button class="btn" id="addRow">+ AÑADIR</button>
          <button class="btn ghost" id="clearAll">LIMPIAR</button>
        </div>

        <label class="mt-md">Comentarios (opcional)</label>
        <input id="note" type="text" placeholder="ej. medir con INA219" />
      </section>

      <aside class="card results">
        <div class="card-header">
          <h2>RESULTADOS</h2>
        </div>

        <div class="stat">
          <div class="stat-label">Corriente media total</div>
          <div class="stat-value" id="I_total_mA">—</div>
          <div class="stat-formula">Σ(I·duty)</div>
        </div>

        <div class="stat">
          <div class="stat-label">Potencia total en carga</div>
          <div class="stat-value" id="P_total_W">—</div>
          <div class="stat-formula">P = Σ(V·I_avg)</div>
        </div>

        <div class="stat">
          <div class="stat-label">Energía batería</div>
          <div class="stat-value" id="Wh_batt">—</div>
          <div class="stat-formula">Wh = V·Ah</div>
        </div>

        <div class="stat">
          <div class="stat-label">Autonomía (método Wh)</div>
          <div class="stat-value" id="hours_wh">—</div>
          <div class="stat-formula">hrs = Wh/(P/eff)</div>
        </div>

        <div class="stat">
          <div class="stat-label">Autonomía (método mAh)</div>
          <div class="stat-value" id="hours_mAh">—</div>
          <div class="stat-formula">hrs ≈ Ah*1k/I</div>
        </div>

        <div class="flex flex-wrap mt-md">
          <button class="btn btn-primary" id="calc">CALCULAR</button>
          <button class="btn" id="exportCSV">EXPORT CSV</button>
        </div>

        <footer>
          Tip: Los resultados son estimaciones. Para medición precisa usar INA219/INA226.
        </footer>
      </aside>
    </div>
  </div>

  <script>
    // Base de datos de consumo típico de componentes Wokwi
    const WOKWI_COMPONENT_SPECS = {
      // Microcontroladores
      'wokwi-arduino-uno': { name: 'Arduino UNO', V: 5.0, I: 45, duty: 100 },
      'wokwi-arduino-nano': { name: 'Arduino Nano', V: 5.0, I: 19, duty: 100 },
      'wokwi-arduino-mega': { name: 'Arduino Mega', V: 5.0, I: 50, duty: 100 },
      'wokwi-esp32-devkit-v1': { name: 'ESP32 DevKit', V: 3.3, I: 160, duty: 100 },
      'board-esp32-c3-devkitm-1': { name: 'ESP32-C3', V: 3.3, I: 120, duty: 100 },
      'board-esp32-s2-devkitm-1': { name: 'ESP32-S2', V: 3.3, I: 140, duty: 100 },
      'board-esp32-s3-devkitc-1': { name: 'ESP32-S3', V: 3.3, I: 150, duty: 100 },
      'board-esp32-c6-devkitc-1': { name: 'ESP32-C6', V: 3.3, I: 130, duty: 100 },
      'wokwi-pi-pico': { name: 'Raspberry Pi Pico', V: 3.3, I: 100, duty: 100 },
      'board-franzininho-wifi': { name: 'Franzininho WiFi', V: 3.3, I: 150, duty: 100 },

      // Sensores
      'wokwi-dht22': { name: 'DHT22', V: 3.3, I: 2.5, duty: 10 },
      'wokwi-ds1307': { name: 'RTC DS1307', V: 5.0, I: 1.5, duty: 100 },
      'wokwi-pir-motion-sensor': { name: 'PIR Motion', V: 5.0, I: 0.065, duty: 10 },
      'wokwi-hc-sr04': { name: 'HC-SR04', V: 5.0, I: 15, duty: 10 },
      'wokwi-mpu6050': { name: 'MPU6050', V: 3.3, I: 3.5, duty: 100 },
      'wokwi-bmp280': { name: 'BMP280', V: 3.3, I: 0.71, duty: 10 },

      // Displays
      'wokwi-lcd1602': { name: 'LCD 16x2', V: 5.0, I: 100, duty: 100 },
      'wokwi-lcd2004': { name: 'LCD 20x4', V: 5.0, I: 120, duty: 100 },
      'wokwi-ssd1306': { name: 'OLED SSD1306', V: 3.3, I: 20, duty: 100 },
      'wokwi-max7219-matrix': { name: 'LED Matrix 8x8', V: 5.0, I: 200, duty: 100 },
      'wokwi-tm1637-7segment': { name: 'TM1637 7-seg', V: 5.0, I: 80, duty: 100 },

      // Actuadores
      'wokwi-servo': { name: 'Servo Motor', V: 5.0, I: 500, duty: 20 },
      'wokwi-buzzer': { name: 'Buzzer', V: 5.0, I: 30, duty: 10 },
      'wokwi-relay-module': { name: 'Relay Module', V: 5.0, I: 70, duty: 50 },
      'wokwi-stepper-motor': { name: 'Stepper Motor', V: 12, I: 600, duty: 30 },

      // Componentes pasivos y activos
      'wokwi-led': { name: 'LED', V: 2.0, I: 20, duty: 100 },
      'wokwi-rgb-led': { name: 'RGB LED', V: 2.0, I: 60, duty: 100 },
      'wokwi-neopixel': { name: 'NeoPixel LED', V: 5.0, I: 60, duty: 100 },
      'wokwi-led-bar-graph': { name: 'LED Bar Graph', V: 2.0, I: 200, duty: 100 },

      // Módulos de comunicación
      'wokwi-nrf24l01': { name: 'NRF24L01', V: 3.3, I: 13.5, duty: 30 },
    };

    // Manejo dinámico de filas
    const rowsEl = document.getElementById('rows');
    const addRowBtn = document.getElementById('addRow');
    const calcBtn = document.getElementById('calc');
    const clearAllBtn = document.getElementById('clearAll');
    const exportBtn = document.getElementById('exportCSV');
    const parseWokwiBtn = document.getElementById('parseWokwi');

    function createRow(data={name:'Componente',V:3.3,I:10,duty:100}){
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input class="name" value="${data.name}" /></td>
        <td><input class="V" type="number" step="0.1" value="${data.V}" /></td>
        <td><input class="I" type="number" step="0.1" value="${data.I}" /></td>
        <td><input class="duty" type="number" step="0.1" value="${data.duty}" min="0" max="100" /></td>
        <td class="row-actions"><button class="btn ghost del">DEL</button></td>
      `;
      rowsEl.appendChild(tr);
      tr.querySelector('.del').addEventListener('click', ()=>{tr.remove();});
      return tr;
    }

    addRowBtn.addEventListener('click', ()=>createRow());

    clearAllBtn.addEventListener('click', ()=>{rowsEl.innerHTML='';});

    function readRows(){
      const trs = Array.from(rowsEl.querySelectorAll('tr'));
      return trs.map(tr=>({
        name: tr.querySelector('.name').value || 'comp',
        V: parseFloat(tr.querySelector('.V').value) || 0,
        I_mA: parseFloat(tr.querySelector('.I').value) || 0,
        duty: parseFloat(tr.querySelector('.duty').value) || 100
      }));
    }

    function calculate(){
      const batt_mAh = parseFloat(document.getElementById('batt_mAh').value) || 0;
      const batt_V = parseFloat(document.getElementById('batt_V').value) || 3.7;
      const eff = parseFloat(document.getElementById('eff').value) || 0.9;

      const items = readRows();
      // Corriente media total en mA (sum(I*mDuty))
      const I_total_mA = items.reduce((s,it)=> s + (it.I_mA * (it.duty/100)), 0);

      // Potencia total (W) = sum(V_i * I_avg_i[A])
      const P_total_W = items.reduce((s,it)=> s + (it.V * (it.I_mA*(it.duty/100)/1000)), 0);

      // Energía batería Wh
      const Wh_batt = batt_V * (batt_mAh/1000);

      // Horas por método Wh: hours = Wh_batt / (P_total_W/eff) (si P_total_W=0 -> inf)
      const hours_wh = P_total_W>0 ? (Wh_batt / (P_total_W / eff)) : Infinity;

      // Horas por método mAh aproximado: assume same V -> hours = (Ah*1000)/I_total_mA
      const hours_mAh = I_total_mA>0 ? ((batt_mAh) / I_total_mA) : Infinity;

      // Mostrar
      document.getElementById('I_total_mA').textContent = I_total_mA.toFixed(2) + ' mA';
      document.getElementById('P_total_W').textContent = P_total_W.toFixed(3) + ' W';
      document.getElementById('Wh_batt').textContent = Wh_batt.toFixed(2) + ' Wh';
      document.getElementById('hours_wh').textContent = isFinite(hours_wh) ? hours_wh.toFixed(2) + ' h (' + (hours_wh/24).toFixed(2) + ' d)' : '—';
      document.getElementById('hours_mAh').textContent = isFinite(hours_mAh) ? hours_mAh.toFixed(2) + ' h (' + (hours_mAh/24).toFixed(2) + ' d)' : '—';

      return {items, batt_mAh, batt_V, eff, I_total_mA, P_total_W, Wh_batt, hours_wh, hours_mAh};
    }

    calcBtn.addEventListener('click', ()=> calculate());

    // Export CSV simple
    exportBtn.addEventListener('click', ()=>{
      const res = calculate();
      const rows = res.items.map(it => [it.name, it.V, it.I_mA, it.duty]);
      let csv = 'name,V(I),I_mA,duty%\n';
      rows.forEach(r=>{csv += r.join(',')+'\n'});
      csv += '\n#SUMMARY\n';
      csv += `batt_mAh,${res.batt_mAh}\n`;
      csv += `batt_V,${res.batt_V}\n`;
      csv += `eff,${res.eff}\n`;
      csv += `I_total_mA,${res.I_total_mA}\n`;
      csv += `P_total_W,${res.P_total_W}\n`;
      csv += `Wh_batt,${res.Wh_batt}\n`;
      csv += `hours_wh,${res.hours_wh}\n`;
      csv += `hours_mAh,${res.hours_mAh}\n`;

      const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'consumo_export.csv'; document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    });

    // Función para parsear y cargar proyecto Wokwi
    function parseWokwiProject() {
      const wokwiJsonText = document.getElementById('wokwi_json').value.trim();
      const wokwiUrl = document.getElementById('wokwi_url').value.trim();

      if (!wokwiJsonText) {
        alert('Por favor, pega el contenido de diagram.json en el campo de texto.');
        return;
      }

      try {
        const diagram = JSON.parse(wokwiJsonText);

        if (!diagram.parts || !Array.isArray(diagram.parts)) {
          alert('El JSON no parece ser un diagram.json válido de Wokwi. Debe contener un array "parts".');
          return;
        }

        // Limpiar tabla actual
        rowsEl.innerHTML = '';

        // Contador de componentes encontrados y no encontrados
        let found = 0;
        let notFound = 0;
        const notFoundTypes = new Set();

        // Procesar cada parte del diagrama
        diagram.parts.forEach(part => {
          const partType = part.type;

          if (WOKWI_COMPONENT_SPECS[partType]) {
            const spec = WOKWI_COMPONENT_SPECS[partType];
            // Crear una copia del spec para poder modificar el nombre si hay attrs
            const componentData = { ...spec };

            // Si el componente tiene un nombre personalizado en attrs, usarlo
            if (part.attrs && part.attrs.label) {
              componentData.name = `${spec.name} (${part.attrs.label})`;
            } else if (part.id) {
              componentData.name = `${spec.name} (${part.id})`;
            }

            createRow(componentData);
            found++;
          } else {
            // Componentes no reconocidos (resistores, capacitores, etc.)
            notFound++;
            notFoundTypes.add(partType);
          }
        });

        // Mostrar resumen
        let message = `✓ Se cargaron ${found} componente(s) desde el proyecto Wokwi.`;
        if (notFound > 0) {
          message += `\n\nℹ ${notFound} componente(s) no fueron agregados (componentes pasivos o no reconocidos):\n`;
          message += Array.from(notFoundTypes).join(', ');
          message += '\n\nPuedes agregar estos componentes manualmente si consumen energía.';
        }

        if (wokwiUrl) {
          message += `\n\n🔗 Proyecto: ${wokwiUrl}`;
        }

        alert(message);

        // Calcular automáticamente después de cargar
        if (found > 0) {
          calculate();
        }

      } catch (error) {
        alert(`Error al parsear el JSON: ${error.message}\n\nAsegúrate de pegar el contenido completo del archivo diagram.json.`);
      }
    }

    parseWokwiBtn.addEventListener('click', parseWokwiProject);

    // Inicializar con un par de filas útiles
    createRow({name:'ESP32 (Wi‑Fi)',V:3.3,I:120,duty:100});
    createRow({name:'HC‑SR04 (siempre ON)',V:5.0,I:15,duty:100});
    // calcular inicial
    calculate();
  </script>
</body>
</html>
